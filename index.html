<!DOCTYPE html>
<html>
<head>
    <title>Student Attendance Scanner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; border-radius: 5px; }
        button { background-color: #008CBA; color: white; border: none; cursor: pointer; font-size: 16px; }
        button:active { opacity: 0.8; }
        .camera-btn { background-color: #4CAF50; font-size: 18px; padding: 15px; }
        .stop-btn { background-color: #f44336; }
        #videoContainer { width: 100%; max-width: 400px; margin: 20px auto; display: none; }
        video { width: 100%; height: auto; border: 2px solid #333; border-radius: 5px; }
        canvas { display: none; }
        #status { margin-top: 10px; padding: 10px; border-radius: 5px; }
        #pendingCount { font-weight: bold; font-size: 24px; color: #4CAF50; }
        .error { background-color: #ffebee; color: #c62828; }
        .success { background-color: #e8f5e8; color: #2e7d32; }
        .info { background-color: #e3f2fd; color: #1565c0; }
        .scan-result { padding: 15px; margin: 10px 0; border-radius: 5px; background-color: #f5f5f5; }
        .header { text-align: center; color: #333; }
        hr { border: 1px solid #ddd; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <h2 class="header">üìö Student Attendance Scanner</h2>
    
    <div id="studentInfo">
        <label>Your Full Name:</label>
        <input type="text" id="studentName" placeholder="Enter your full name" required>
        
        <label>Student ID:</label>
        <input type="text" id="studentId" placeholder="Enter your ID" required>
        
        <button onclick="saveStudentInfo()" style="background-color: #4CAF50;">üíæ Save My Info</button>
    </div>
    
    <hr>
    
    <div id="cameraControls" style="display:none;">
        <h3>üì∑ Scan QR Code</h3>
        
        <div id="cameraStatus" class="info">Ready to scan</div>
        
        <button onclick="startScanner()" class="camera-btn" id="startCameraBtn">‚ñ∂Ô∏è START CAMERA</button>
        <button onclick="stopScanner()" class="stop-btn" id="stopCameraBtn" style="display:none;">‚èπÔ∏è STOP CAMERA</button>
        
        <div id="videoContainer">
            <video id="video" playsinline></video>
        </div>
        
        <canvas id="canvas"></canvas>
        
        <div id="scanResult" class="scan-result"></div>
    </div>
    
    <hr>
    
    <div>
        <h3>üìã Pending Records: <span id="pendingCount">0</span></h3>
        <button onclick="syncAttendance()" style="background-color: #ff9800;">üîÑ SYNC NOW</button>
        <button onclick="viewPending()" style="background-color: #9c27b0; color: white;">üëÅÔ∏è View Pending</button>
        <button onclick="clearAllData()" style="background-color: #f44336;">üóëÔ∏è Clear All</button>
    </div>
    
    <div id="status"></div>
    <pre id="pendingList" style="background:#f4f4f4; padding:10px; display:none; overflow:auto;"></pre>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgYw-2YMjmZKQl83r11ya9NoUkpBFA4NdF5RolHqwcEYlPHjBCFLXoVxosMcEaZT-8sw/exec';
        
        const PENDING_QUEUE_KEY = 'attendanceQueue';
        const STUDENT_INFO_KEY = 'studentInfo';
        
        let videoStream = null;
        let scanning = false;
        let scanTimeout = null;
        
        window.onload = function() {
            loadStudentInfo();
            updatePendingCount();
            checkSavedInfo();
        };
        
        function loadStudentInfo() {
            const saved = localStorage.getItem(STUDENT_INFO_KEY);
            if (saved) {
                const info = JSON.parse(saved);
                document.getElementById('studentName').value = info.name || '';
                document.getElementById('studentId').value = info.id || '';
            }
        }
        
        function checkSavedInfo() {
            if (localStorage.getItem(STUDENT_INFO_KEY)) {
                document.getElementById('cameraControls').style.display = 'block';
                document.getElementById('cameraStatus').innerHTML = '‚úÖ Info saved - click START CAMERA';
            }
        }
        
        function saveStudentInfo() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            
            if (!name || !id) {
                alert('Please enter both name and ID');
                return;
            }
            
            localStorage.setItem(STUDENT_INFO_KEY, JSON.stringify({ name, id }));
            document.getElementById('cameraControls').style.display = 'block';
            document.getElementById('cameraStatus').innerHTML = '‚úÖ Ready! Click START CAMERA';
            document.getElementById('status').innerHTML = '<span class="success">‚úÖ Info saved successfully!</span>';
        }
        
        function startScanner() {
            if (!localStorage.getItem(STUDENT_INFO_KEY)) {
                alert('Please save your info first.');
                return;
            }
            
            document.getElementById('startCameraBtn').style.display = 'none';
            document.getElementById('stopCameraBtn').style.display = 'block';
            document.getElementById('videoContainer').style.display = 'block';
            document.getElementById('cameraStatus').innerHTML = 'üì± Requesting camera...';
            
            const video = document.getElementById('video');
            
            if (videoStream) {
                stopScanner();
            }
            
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.setAttribute('autoplay', true);
                    video.setAttribute('muted', true);
                    
                    return video.play();
                })
                .then(() => {
                    scanning = true;
                    document.getElementById('cameraStatus').innerHTML = '‚úÖ Camera active - point at QR code';
                    document.getElementById('status').innerHTML = '<span class="success">‚úÖ Camera working! Scan QR code.</span>';
                    scanFrame();
                })
                .catch(err => {
                    console.error('Camera error:', err);
                    
                    document.getElementById('startCameraBtn').style.display = 'block';
                    document.getElementById('stopCameraBtn').style.display = 'none';
                    document.getElementById('videoContainer').style.display = 'none';
                    
                    let errorMsg = '';
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMsg = '‚ùå Please allow camera access when prompted';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = '‚ùå No camera found on this device';
                    } else {
                        errorMsg = '‚ùå Error: ' + err.message;
                    }
                    
                    document.getElementById('cameraStatus').innerHTML = errorMsg;
                    document.getElementById('status').innerHTML = '<span class="error">' + errorMsg + '</span>';
                });
        }
        
        function stopScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            scanning = false;
            if (scanTimeout) {
                cancelAnimationFrame(scanTimeout);
                scanTimeout = null;
            }
            
            document.getElementById('video').srcObject = null;
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'block';
            document.getElementById('stopCameraBtn').style.display = 'none';
            document.getElementById('cameraStatus').innerHTML = 'Camera stopped - click START CAMERA';
        }
        
        function scanFrame() {
            if (!scanning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!canvas) {
                console.error('Canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (!ctx) {
                console.error('Could not get canvas context');
                return;
            }
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                try {
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        stopScanner();
                        processScannedCode(code.data);
                        return;
                    }
                } catch (e) {
                    console.error('QR scan error:', e);
                }
            }
            
            scanTimeout = requestAnimationFrame(scanFrame);
        }
        
        function processScannedCode(data) {
            try {
                const lectureData = JSON.parse(data);
                
                if (!lectureData.lectureId || !lectureData.course) {
                    throw new Error('Invalid QR data');
                }
                
                const studentInfo = JSON.parse(localStorage.getItem(STUDENT_INFO_KEY));
                const timestamp = new Date().toISOString();
                
                const record = {
                    timestamp: timestamp,
                    studentName: studentInfo.name,
                    studentId: studentInfo.id,
                    lectureId: lectureData.lectureId,
                    course: lectureData.course,
                    location: lectureData.location || 'Unknown',
                    date: lectureData.date || 'Unknown'
                };
                
                addToQueue(record);
                
                document.getElementById('scanResult').innerHTML = 
                    `<strong>‚úÖ RECORDED!</strong><br>
                     üìö ${lectureData.course}<br>
                     üìç ${lectureData.location || 'Unknown'}<br>
                     üìÖ ${lectureData.date || 'Unknown'}`;
                
                updatePendingCount();
                
                setTimeout(() => {
                    if (confirm('Scan another QR code?')) {
                        startScanner();
                    }
                }, 1000);
                
            } catch (e) {
                alert('Invalid QR code');
                console.error(e);
            }
        }
        
        function getQueue() {
            const queue = localStorage.getItem(PENDING_QUEUE_KEY);
            return queue ? JSON.parse(queue) : [];
        }
        
        function addToQueue(record) {
            const queue = getQueue();
            queue.push(record);
            localStorage.setItem(PENDING_QUEUE_KEY, JSON.stringify(queue));
        }
        
        function updatePendingCount() {
            const queue = getQueue();
            document.getElementById('pendingCount').innerText = queue.length;
        }
        
        function viewPending() {
            const queue = getQueue();
            const pre = document.getElementById('pendingList');
            
            if (pre.style.display === 'none' || pre.style.display === '') {
                pre.style.display = 'block';
                pre.textContent = JSON.stringify(queue, null, 2);
            } else {
                pre.style.display = 'none';
            }
        }
        
        function clearAllData() {
            if (confirm('Delete ALL data?')) {
                localStorage.removeItem(STUDENT_INFO_KEY);
                localStorage.removeItem(PENDING_QUEUE_KEY);
                location.reload();
            }
        }
        
        function syncAttendance() {
            const queue = getQueue();
            
            if (queue.length === 0) {
                alert('No records to sync');
                return;
            }
            
            document.getElementById('status').innerHTML = '<span class="info">üîÑ Syncing...</span>';
            
            let successCount = 0;
            let failedIndices = [];
            
            function syncNext(index) {
                if (index >= queue.length) {
                    if (failedIndices.length > 0) {
                        const newQueue = queue.filter((_, i) => failedIndices.includes(i));
                        localStorage.setItem(PENDING_QUEUE_KEY, JSON.stringify(newQueue));
                        document.getElementById('status').innerHTML = 
                            `<span class="error">‚ö†Ô∏è Synced ${successCount}, failed ${failedIndices.length}</span>`;
                    } else {
                        localStorage.removeItem(PENDING_QUEUE_KEY);
                        document.getElementById('status').innerHTML = '<span class="success">‚úÖ All synced!</span>';
                    }
                    updatePendingCount();
                    return;
                }
                
                const record = queue[index];
                const payload = {
                    target: 'attendance',
                    ...record
                };
                
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    successCount++;
                    syncNext(index + 1);
                })
                .catch(error => {
                    console.error('Sync failed:', error);
                    failedIndices.push(index);
                    syncNext(index + 1);
                });
            }
            
            syncNext(0);
        }
    </script>
</body>
</html>
